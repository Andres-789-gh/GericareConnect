<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agregar Paciente - GeriCare Connect</title>
    <link rel="stylesheet" href="../../admin/css_admin/agregar_paciente.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css">
    <style>
        .info-box { background-color: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; padding: 10px 15px; border-radius: 4px; margin-bottom: 15px; }
        .error-box { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; padding: 10px 15px; border-radius: 4px; margin-top: 15px; }
        .error-msg { margin: 0; padding: 0; font-weight: bold; }
        .success-box { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; padding: 10px 15px; border-radius: 4px; margin-top: 15px; }
        .success-msg { margin: 0; padding: 0; font-weight: bold; }
        #feedback-container { margin-top: 15px; text-align: left; }
    </style>
</head>
<body>
    <header class="admin-header animated fadeInDown">
        <div class="logo-container">
            <img src="../../imagenes/Geri_Logo-..png" alt="Logo de la aplicación" class="logo" onclick="window.location.href='admin_pacientes.html'">
            <span class="app-name">GERICARE CONNECT</span>
        </div>
        <nav>
            <ul>
                <li><a href="admin_pacientes.html"><i class="fas fa-user-injured"></i> Pacientes</a></li>
                <li><a href="admin_solicitudes.html"><i class="fas fa-envelope-open-text"></i> Solicitudes</a></li>
                <li><a href="../../../controllers/admin/logout.php"><i class="fas fa-sign-out-alt"></i> Cerrar Sesión</a></li>
            </ul>
        </nav>
    </header>
    <main class="admin-content">
        <div class="agregar-paciente-container animated fadeInUp">
            <h1 class="animated slideInLeft"><i class="fas fa-user-plus"></i> Agregar Nuevo Paciente</h1>

            <div id="feedback-container"></div>

            <form id="formulario-agregar-paciente" class="agregar-paciente-form">
                <input type="hidden" id="solicitud_origen_id" name="solicitud_origen_id" value="">
                <input type="hidden" id="familiar_solicitante_id" name="familiar_solicitante_id" value="">

                <div class="form-group animated fadeIn delay-0-5s">
                    <label for="nombres"><i class="fas fa-user"></i> Nombres:</label>
                    <input type="text" id="nombres" name="nombres" required>
                </div>
                <div class="form-group animated fadeIn delay-0-7s">
                    <label for="apellidos"><i class="fas fa-user"></i> Apellidos:</label>
                    <input type="text" id="apellidos" name="apellidos" required>
                </div>
                <div class="form-group animated fadeIn delay-0-9s">
                    <label for="correo"><i class="fas fa-envelope"></i> Correo Electrónico:</label>
                    <input type="email" id="correo" name="correo" required>
                </div>
                <div class="form-group animated fadeIn delay-1-1s">
                    <label for="tipo_documento"><i class="fas fa-id-card-alt"></i> Tipo de Documento:</label>
                    <select id="tipo_documento" name="tipo_documento" required>
                        <option value="">Selecciona</option>
                        <option value="CC">Cédula de Ciudadanía</option>
                        <option value="TI">Tarjeta de Identidad</option>
                        <option value="CE">Cédula de Extranjería</option>
                        <option value="PA">Pasaporte</option>
                    </select>
                </div>
                <div class="form-group animated fadeIn delay-1-3s">
                    <label for="documento"><i class="fas fa-passport"></i> Número de Documento:</label>
                    <input type="text" id="documento" name="documento" required>
                </div>
                <div class="form-group animated fadeIn delay-1-5s">
                    <label for="password"><i class="fas fa-key"></i> Contraseña:</label>
                    <input type="password" id="password" name="password" required>
                </div>
                <div class="form-group animated fadeIn delay-1-7s">
                    <label for="confirm_password"><i class="fas fa-check-double"></i> Confirmar Contraseña:</label>
                    <input type="password" id="confirm_password" name="confirm_password" required>
                </div>
                <button type="button" class="submit-button animated fadeInUp delay-2s" onclick="enviarFormularioAgregarPaciente()">
                    <i class="fas fa-save"></i> Guardar Paciente
                </button>
            </form>
        </div>
    </main>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const urlParams = new URLSearchParams(window.location.search);
            const dataParam = urlParams.get('data');
            const feedbackContainer = document.getElementById('feedback-container');
            const formulario = document.getElementById('formulario-agregar-paciente');

            if (dataParam) {
                feedbackContainer.innerHTML = '';
                try {
                    const datos = JSON.parse(decodeURIComponent(dataParam));
                    console.log("Datos recibidos para autocompletar:", datos);

                    if (datos.solicitud_id) {
                        const inputSolicitud = formulario.querySelector('#solicitud_origen_id');
                        if (inputSolicitud) inputSolicitud.value = datos.solicitud_id;
                        else console.warn("Campo oculto 'solicitud_origen_id' no encontrado.");
                    }
                    if (datos.familiar_id) {
                        const inputFamiliar = formulario.querySelector('#familiar_solicitante_id');
                        if (inputFamiliar) inputFamiliar.value = datos.familiar_id;
                        else console.warn("Campo oculto 'familiar_solicitante_id' no encontrado.");
                    }

                    if (datos.paciente) {
                        const p = datos.paciente;
                        document.getElementById('nombres').value = p.nombres || '';
                        document.getElementById('apellidos').value = p.apellidos || '';
                        document.getElementById('documento').value = p.cc || '';


                        if (p.cc) {
                            document.getElementById('tipo_documento').value = 'CC';
                        }
                    } else {
                        console.warn("No se encontraron datos del paciente en el JSON.");
                    }

                     if(feedbackContainer) {
                        feedbackContainer.innerHTML = `<div class="info-box"><p>Completando datos desde la solicitud #${datos.solicitud_id || '?'}. Por favor, verifique la información, complete los campos faltantes (Correo, Contraseña) y asigne una contraseña segura.</p></div>`;
                     }

                     document.getElementById('correo').focus();

                } catch (e) {
                    console.error("Error al parsear datos JSON de la URL para autocompletar:", e);
                     if(feedbackContainer) {
                         feedbackContainer.innerHTML = `<div class="error-box"><p>Error al cargar datos de la solicitud para autocompletar.</p></div>`;
                      }
                }
            }
        });

        function enviarFormularioAgregarPaciente() {
            const formulario = document.getElementById('formulario-agregar-paciente');
            const feedbackContainer = document.getElementById('feedback-container');
            const formData = new FormData(formulario);
            const submitButton = formulario.querySelector('.submit-button');

            const password = formData.get('password');
            const confirmPassword = formData.get('confirm_password');
            const correo = formData.get('correo');

            feedbackContainer.innerHTML = '';
            let errores = [];

            if (!formData.get('nombres')) errores.push('Nombres es requerido.');
            if (!formData.get('apellidos')) errores.push('Apellidos es requerido.');
            if (!correo) {
                 errores.push('Correo es requerido.');
             } else {

                 const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                 if (!emailRegex.test(correo)) {
                     errores.push('Formato de correo inválido.');
                 }
             }
            if (!formData.get('tipo_documento')) errores.push('Tipo de documento es requerido.');
            if (!formData.get('documento')) errores.push('Número de documento es requerido.');
            if (!password) {
                 errores.push('Contraseña es requerida.');
             } else if (password.length < 6) {
                 errores.push('La contraseña debe tener al menos 6 caracteres.');
            }
            if (password !== confirmPassword) {
                 errores.push('Las contraseñas no coinciden.');
            }


             if (errores.length > 0) {
                 let errorHtml = '<ul>';
                 errores.forEach(err => { errorHtml += `<li>${err}</li>`; });
                 errorHtml += '</ul>';
                 feedbackContainer.innerHTML = `<div class="error-box"><p class="error-msg">Por favor corrige los siguientes errores:</p>${errorHtml}</div>`;
                 return;
             }


            submitButton.disabled = true;
            submitButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Guardando...';

            fetch('../../../controllers/admin/agregar_paciente_procesar.php', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                     feedbackContainer.innerHTML = `<div class="success-box"><p class="success-msg">${data.message || 'Paciente agregado con éxito.'}</p></div>`;
                     formulario.reset();

                     setTimeout(() => {
                         if (window.opener && !window.opener.closed) {

                              try {
                                  window.opener.cargarSolicitudesAdmin();
                                } catch(e) {
                                   console.warn("No se pudo recargar la lista de solicitudes en la ventana anterior:", e);
                                   try { window.opener.location.reload(); } catch(e2) {}
                                }
                         }
                         window.close();
                     }, 2500);
                } else {

                     let errorMsg = 'Ocurrió un error.';
                     if (typeof data.message === 'string') {
                         errorMsg = data.message;
                     } else if (Array.isArray(data.message)) {
                         errorMsg = '<ul>' + data.message.map(err => `<li>${err}</li>`).join('') + '</ul>';
                     }
                     feedbackContainer.innerHTML = `<div class="error-box"><p class="error-msg">${errorMsg}</p></div>`;
                }
            })
            .catch(error => {
                console.error('Error en fetch:', error);
                feedbackContainer.innerHTML = `<div class="error-box"><p class="error-msg">Error de conexión al guardar el paciente.</p></div>`;
            })
             .finally(() => {
                 submitButton.disabled = false;
                 submitButton.innerHTML = '<i class="fas fa-save"></i> Guardar Paciente';
             });
        }
    </script>
</body>
</html>